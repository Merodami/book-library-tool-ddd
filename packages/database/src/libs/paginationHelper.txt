import { Collection, Document, Filter, WithId } from 'mongodb'
import { Request } from 'express'
import { PaginatedResponse } from '@book-library-tool/types'
import { MongoDatabase } from '../MongoDatabase.js'

/**
 * Helper function to fetch paginated data from any collection
 * Can be used from any handler
 */
export async function getPaginatedData<T extends Document = Document>(
  collection: Collection<T>,
  query: Filter<T> = {},
  req: Request,
  options?: {
    projection?: Record<string, number>
    sort?: Record<string, 1 | -1>
  },
): Promise<PaginatedResponse<WithId<T>>> {
  // Get pagination parameters from request (added by middleware)
  const { page, limit } = req.pagination

  const dbService = new MongoDatabase()

  await dbService.connect()

  // Use the DatabaseService's paginateCollection method
  return dbService.paginateCollection(
    collection,
    query,
    { page, limit },
    options,
  )
}
